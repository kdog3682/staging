export { AMDVisitor }
import * as variables from "/home/kdog3682/2023/variables.js"
/* deno-fmt-ignore */ import {fooga, pop4, map4, AbstractVisitor, shellEscape, getkv, toggleBooleanState, numbered, noidea, assertObjectValue, assertValue, getClasses, exit, choose, getFileName, testEqual, pause, getBindingValueString, templater2, smartDedent5, pop3, moduleExports, joinPath, expandPath, isDecimal, hasPercentage, ass, parsePercentage, Matrix, isInteger, isEquation, isObjectObject, getExtraIndent, shellUnescape, assertEqual, asyncToggle, touched, chosen, lastOf, firstOf, isBlockEnter, group3, loremIpsum, exportString, deepToggle, maybeNewlineIndent, onAndOff, flattenModule, isModule, isNativeHtmlTag, partitionByValues, strcall, getLongest2, must, mconfig, unreachable, storager, joiner, removeVeryStartingComments, ireplace, removeCommentsInPlace, editf, getLineTokens, IndexedStore, abstractError, bool, xassert, getSetLines, inMiddle, replaceLast, ensureExtension, multipleReplacer, getGradeLevel, constructEdit, getYear, Modulus, wrapClassMethods, proseReplacer, parseComments, parseFunctionDictComments, todo, dictAssertion, boundModularIncrement, construct, reduceToString2, pageTurner, assignCumulative, defaultMergeStrategy, dictSetter3, toArguments, reTemplate, parseFrontmatter, typeAssertion, defineGetter, assignAllowed, simpleRecursiveWalk, simpleArgument, exprTemplater, stringifyIfNotPrimitive, panic, stringerf, wrapFunction, regexTemplater, iso8601, strftime, walkChildEntries, getFiletype, matchf, isUrl, looksLikeFunction, toArgument2, notNull, CumulativeStorage2, simpleAssign, findAndMatch, infuseObjectArray, regexGetter, splitArg, isJavascriptComment, runTest, everyOther, splitByRange, get_regex, getImports, isJavascriptFile, isValidDateString, WriteObject, equalityf, group2, splitOnce2, dedent4, isLowerCase, looksLikeRegExpString, isRegExpString, getDependencies, camelSplit, toggle3, countf, isLiteralObject, bindMethodsAndState2, call, mget3, looks_like_object_function, create_functions_from_master, toStringArgumentPretty, codeChunks, smart_map, run_tests, hasStartingCallable, mapTemplate, aliaser, fixSelector, htmlTags, removePythonComments, simpleStringBreaker, colonConfig, operations, error, redColon, so2, group, parseSingleLineJson, Items, findDependencies, tryf, find4, localeString, cssComment, colonConfigf, trimArray, parseCallable, bringToLifeTextFix, localBringToLife, getCaller4, getErrorStack, forEach, getBindings, getExports, matchstr, filter4, allEqual, count, isNativeFunction, repeat, eat, getIndentAndText, StopWatch, stringDictSetter, getFunctionInfo, runRef, toLines, hasCallable, getProseWords, tally, paramify, codeSplit, debugConfig, logConfig, blueColon, toStringArgument3, stringCallable, simpleBinding, dashSplit4, appendBelow, appendAbove, removeLineComments, prependIfNecessary, smartDedent4, blueSandwich, walk4, findLineIndex, parseAB, applyTransform, kebabCase, getExcerpt, sortObject, buildFunction, maybeSort, parseFunction, isTypable, frontMatter, dictEntry, insertAfterIndex, State, bindMethods, cpop, tagRE, toggle2, createFunction2, assignIncrementedIndex, ufa, assignArray, regexFromComment, createParsersFromObject, imatch, globalConsoleDebug, bindMethodsAndState, isQuestion, oxfordComma, isUpperCase, getFunctionIdentifier, filter3, match, getMatch, alternatef, reCombine, assertion2, deepEqual, hasDollar, so, deepAssign, Tally, getFunctionNames, throwError, notEqual, tryString, prettyPrintCodeSnippet, prettyPrintErrorStack, iter, quotify, transformerf, assign, defineBinding, linebreak, stringCall2, reduce3, getClassParameters, assignOnTop2, isIdentifier, ndy, dashSplit3, runFunctionFromRef, equalf, alphabet, stateGetterFromSchema, mreplace, require, topLineComment, isChinese, replacef, ignoref, codeLibrary, splitLines, addArgumentQuotes, getBindings2, addCaret, mget2, getStartingConfig, incrementalEat, strlen, hr, setOnce, unescapeHtml, oxford, breakerf, runTests, map3, dateSplit, transformDict, walk3, toRegExp, tryAgainf, assertNotNull, getArgumentObject, isArgumentObject, typef, requireArg, keyAndValue, assignf, stateGetter3, objectFromArguments2, assignDefaults, transformValue, assign3, assignFresh3, evaluate3, scopedEvaluator, objectFromArguments, enforce, sub, filterObject, extractStartingJsonLikeConfig, unbrackify, newlineIndent2, deleteLine, both, normalizeIndent, getComment, secondComment, isStringRegExp, dashSplit2, clock, warning, errorStringify, alert, labelCase, bottomComment, stringCompose, getAnyIdentifier, chalkf, getNumbers, partitions, has, addUnit, toCallable, unquote, filter2, warn2, join2, caller2, assignOnce, longShort, shortLong, argPop, caller, assignOnTop, toggle, defineWindow, unescapeNewlines, escapeQuotes, unescapeQuotes, escapeNewlines, setAliases, announceCaller, removeStartingComments, smartBind, assignExisting, isObjectWithKey, eatStart, modularIncrementItem, getRegex, runFunction, isObjectLikeArray, itemGetter2, getAllKeys, prefixSlice, hasQuotes, assertion, diff, toggleState, initState, dunder, objectGetter, superTransform, popFilter, testRunner, assert2, insertAtDollar, popEmptyLine, getOptions, mergeSpecs, sortByKeys, map2, strictMessengerAssert, smartSplit, chalk4, typeLog, getFunctionName, Clock, search3, MyError, fuzzyMatch3, debugDisplay, getCaller3, messengerAssert, camelSlice, setPrototype, assignAliases, display, modifyNumber, toDict, setPush, modularIncrementIndex, longstamp, popIndex, toggleOnOff, locWrap, walk2, typeMatch, prettyStringify, getIdentifiers, CustomError, argMatch, brackify2, smartestDedent, modularIncrementNumber, AbstractMethodError, allUnique, Trie, boundarySplit, numberBoundarySplit, nodeLog, getFirst, defineProperty, supermix, partial, timeLog, timestamp, raise, getIdentifier, conditionalPrefix, conditionalSuffix, QueryList, fuzzyMatch2, buildDict, getTextAndCommand, sprawlFactory, getParameters2, pushf, intersection, union, blue, green, sandwich, getLastSpaces, smartDedent3, red, sort, debounce, checkValue, getCodeChunks, logf, boundary, myError, conditional, isStringFunction, toSpaces, objectf, searchAll, difference, singleQuote, itemGetter, slice2, mergeObjects, once, dashSplit, nchalk, coerceToObject, ArrayState, exporter2, indent2, iterator, removeAllComments, countParams, cumulativeSchemaAssign, argKwargSplit, argParse, removeInlineComments, getFrontMatter, hasHtmlSuffix, lazyArray, isThisFunction, escapeHTML, getKwargs2, search2, toStringArgument, createFuzzyMatch, edit2, splice, zip, merge2, argArgsKwargs, fill2, chalk, vueWrap, splitArray, splitArray2, warn, makeRunner2, searchf2, smartDedent2, dedent2, toArray2, stateGetter2, sortByIndex, IndexedCache, argo, curry2, doUntil2, evaluate2, findall2, findIndex2, findItem2, getCaller2, getErrorStack2, isJson, indexGetter2, insert2, pop2, parseError2, remove2, reduce2, testf2, type2, unshift2, waterfall2, xsplit2, Cache, cumulativeAssign, replaceBefore, topComment, isAsyncFunction, mapSort, getFileURI, getQuotes, isClassObject, isInitialized, getFallback, bindingRE, addObjectOrObjectProperty, forDoubles, isCss, log, iterate, backAndForth, round, iteratorWrapper, toJSON, isFromMap, toString, empty, conditionalString, getConfigArg, hasKey, errorWrap, successWrap, check, toPoints, bind, mixinAliases, isPercentage, isBasicType, reducerStrategy, gather, entries, stateGetter, methodCase, vueCase, push2, smarterIndent, lineSplit, Store, isSingleLetter, prepareText, isSymbol, getShortest, slice, KeyError, deepCopy, argsKwargs, isError, isColor, list, objectEditor, matchall, makeFastRunner, announce, hasLetter, filter, reduce, stringCall, capitalizeName, stop, proseCase, lineDitto, mixinSetters, modularIncrement, distinct, definedSort, groupBy, reWrap2, fuzzyMatch, isPlural, Element, parseError, isPrimitiveArray, callableArgsKwargs, waterfall, defineVariable, info, flat2D, splitThePage, handleError, dedent, TypeAssertion, createFunction, pluralize, remove, Group, PageStorage, Storage, UniqueStorage, Watcher, arrayToDict, addProperty, addQuotes, argWrapFactory, assert, abrev, abf, addExtension, assignFresh, antif, atFirst, atSecond, backspace, bindObject, breaker, blockQuote, brackify, bringToLife, comment, countCaptureGroups, capitalizeTitle, classMixin, callableRE, camelToTitle, curry, createVariable, changeExtension, curryStart, curryEnd, capitalize, copy, camelCase, compose, char2n, camelToDash, deepMerge, datestamp, doublef, dictSetter, dictSetter2, dsearch, doUntil, dashCase, doubleQuote, dict, dictGetter, depluralize, dreplace, dictf, endsWithWord, exporter, edit, exists, evaluate, extend, find, flatMap, fill, fixUrl, functionGetter, findall, fixPath, flat, fparse, findIndex, firstLine, ftest, getKwargs, getFirstName, getBindingName, getParameters, getLastWord, getCodeWords, getCodeWords2, getIndent, getExtension, getLast, getLongest, getChunks, getCaller, getStackTrace, getConstructorName, getFirstWord, getWords, getSpaces, hasComma, hasSpaces, hasHtml, hasBracket, hasNewline, hasCaptureGroup, hasEquals, hasValue, hasCamelCase, hasNumber, hackReplace, insert, indexGetter, incrementf, isCallable, isQuote, isEven, isOdd, isLast, isHTML, isNode, interweave, inferLang, isString, isArray, isObject, isDefined, isFunction, isPrimitive, isNumber, isSet, isNestedArray, indent, isNull, isWord, isBoolean, isRegExp, identity, isObjectLiteral, isJsonParsable, isCapitalized, isNewLine, isObjectArray, isStringArray, isClassFunction, joinSpaces, join, keyArrayToObject, lowerCase, linebreakRE, len, lineGetter, lineCount, lastLine, logConsole, makeRunner, mixin, modularf, matchGetter, merge, mget, map, mergeOnTop, mergeToObject, mapFilter, noop, nestPush, no, newlineIndent, n2char, objectWalk, overlap, objectToString, opposite, pipe, parseTopAttrs, pascalCase, partition, parens, push, pop, parseJSON, rigidSort, removeQuotes, rep, removeComments, range, removeExtension, rescape, reverse, reWrap, reduceToString, repeatUntil, swapKey, sayhi, swap, splitMapJoin, splitCamel, smallify, search, stringify, shared, smartDedent, stringBreaker, sleep, split, snakeCase, stringArgument, sorted, splitOnce, searchf, secondLine, titleCase, textOrJson, toNumber, toArgument, toNestedArray, test, type, tail, transformObject, trim, testf, toArray, templater, totalOverlap, upperCase, unique, uncapitalize, wrap, walk, wrapf, xsplit, yes, zip2} from "/home/kdog3682/2023/utils.js"
/* deno-fmt-ignore */ import {saver, clear, head, raw, cp, smartpath, python3, dataJsonFileManager, absdir, append, bash, clip, cpdir, cwd, deleteFiles, denoFileRunner, denoImports, forceWrite, getAppFunction, getFiles, getFilesRecursively, getModuleFunc, getMostRecentFile, getVimSectionText, gitClone, isDir, isFile, moveFiles, mv, notify, npath, openFile, panicPrompt, read, readdir, rename, requestAppend, requestWrite, rmdir, rpw, select, sysArgs, textAndLang, unzip, write, xselect} from "/home/kdog3682/2024-javascript/nodekit/deno.js"


class AMDVisitor {
    visit(ast, env) {
        const key = ast.name
        const Cob = ClassRef[key]

        if (Cob) {
            const visit = (child) => {
                return this.visit(child, env)
            }
            const children = ast.children.map(visit)
            const child = new Cob(children)
            // this represents a postOrderTraverse
            return child
        } else {
            const visit = AstRef[key]
            if (visit) {
                return visit(ast, env)
            }
            exit(ast, 'missing', key)
            // panic('todo $1', key)
        }
    }
}



class Grouping {
    constructor(children, parent) {
        this.parent = parent
        this.children = children
        this.state = {}
        this.init && this.init()
        this.run && this.run()
    }
    appendChild(child) {
        this.children.push(child)
        if (isString(child)) {
            return 
        }
        child.parent = this
        return child
    }
    toString() {
        const kids = this.children.map(String)
        if (this.template) {
            return templater3(this.template(), kids)
        }
        return kids.join("")
    }
    emit(k, v) {
        this.parent.state[k] = v
    }
    get a() {
        return this.children[0]
    }
    get b() {
        return this.children[1]
    }
    get c() {
        return this.children[2]
    }
    append(s) {
        const parent = findParent(this, 'appends')
        parent.append(s)
        return this
    }
    prepend(s) {
        const parent = findParent(this, 'prepends')
        parent.prepend(s)
        return this
    }
}

function join3(args) {
    let s = ""
    for (let i = 0; i < args.length; i++) {
        const arg = args[i]
        const spaces = hasNewline(arg) ? "\n\n" : "\n"
        s += arg + spaces
    }
    return s.trim()
}
function block(children, o = {}) {
    let s = children.map(String)
    s = join3(s)
    if (o.indent) {
        s = indent2(s)
    }
    if (o.wrapper) {
        s = wrap(s, o.wrapper)
    }
    return s
}
class Block extends Grouping {
    toString() {
        const opts = { indent: true, wrapper: "{\n\n}" }
        return block(this.getItems(), opts)
    }
    getItems() {
        const children = this.children.map(String)
        return merge2(this.prepends, children, this.appends)
    }
    init() {
        this.prepends = []
        this.appends = []
    }
    prepend(value) {
        this.prepends.push(value)
    }
    append(value) {
        this.appends.push(value)
    }
}

class Script extends Block {
    toString() {
        const items = this.getItems()
        return block(items)
    }
    run() {
        console.log('exiting at script')
        exit(this.toString())
    }
}
class WhileStatement extends Grouping {
    // constructor([expression, statement]) {
    // this.expression = expression
    // this.statement = statement
    // }
    init() {
        // this.b.prepend("// yolo")
        // this.b.append("// yolo")
    }
    template() {
        // b is a Block
        // pause(this.b)
        return "while ($1) $2"
    }
}
class VariableDeclaration extends Grouping {
    toString() {
        return "asdf = asdfsadf"
    }
}

function findParent(state, key) {
    while (state = state.parent) {
        if (key in state) {
            return state
        }
    }
}
class ArrowFunction extends Grouping {
    toString() {
        return 'abbbb'
    }
    init() {
        exit(this.parent)
        this.prepend('// howdy')
        exit(this)
        pause('a')
    }
}

class CallExpression extends Grouping {
    template() {
        return '$1($2)'
    }
}
class ArgList extends Grouping {
    // you cannot have lambda expressions
    init() {
        throw 'hi'
        // pause(this)
        // pause(this.parent)
        // pause(this.children)
        // pause(this)
    }
    // toString() {
        // return 'abc'
    // }
    // collect() {
        // return
        // pause(this.children.map(smartString))
        // pause(this.children)
    // }
}





const AstRef = {
    VariableDefinition({ value }, env) {
        env.declareVar(value, true)
        return value
    },
    VariableName({ value }, env) {
        env.touch(value)
        return value
    },
}

class ExpressionStatement extends Grouping {
    constructor(children) {
        throw 'hi'
        pause(children)
    }
}
class ParamList extends Grouping {
    constructor(children) {
        super(children)
        exit(this)
        pause(children)
    }
    toString() {
        console.log('aaaaaa')
        pause('aa')
    }
}
const ClassRef = {
    Script,
    ExpressionStatement,
    Block,
    CallExpression,
    ArgList,
    ArrowFunction,
    ParamList,
    WhileStatement,
}

const ast = read('/home/kdog3682/2024-javascript/staging/amd.json')
// exit(ast)
console.log((new AMDVisitor()).visit(ast, env))

// the next version of /home/kdog3682/2024-javascript/staging/addMissingDependencyVisitors.js
// /home/kdog3682/2024-javascript/staging/amd.json ... the input json
// /home/kdog3682/2024-javascript/staging/lezer-workspace.js


class AMDElement {
    constructor(state, parent) {
        this.children = []
        this.parent = parent
    }
}
// doesnt work ...
function traverse(node) {
    function runner(node, parent, env) {
        const Cob = ClassRef[node.name]
        const cob = new Cob(parent, env)
        if (node.children) {
            cob.children = node.children.map((child) => {
                return runner(child, cob)
            })
            return cob
        } else {
            return node
        }
    }
    const env = new Environment(null, null, {relaxed: true})
    return runner(node, null, env)
}
